# sql.yaml - This file contains SQL statements used by Crackup.
---
archive_data:
  create: |
    CREATE TABLE IF NOT EXISTS archive_data (
      path     TEXT PRIMARY KEY,
      filedata BLOB
    );

archive_index:
  create: |
    CREATE TABLE IF NOT EXISTS archive_index (
      path       TEXT PRIMARY KEY,
      hash       TEXT NOT NULL,
      byte_start INTEGER NOT NULL,
      byte_end   INTEGER NOT NULL
    );

archive_meta:
  create: |
    CREATE TABLE IF NOT EXISTS archive_meta (
      creator_name    TEXT,
      creator_version TEXT,
      creator_url     TEXT
    );

chunks:
  create: |
    CREATE TABLE IF NOT EXISTS chunks (
      id         INTEGER PRIMARY KEY AUTOINCREMENT,
      file_path  TEXT NOT NULL,
      byte_start INTEGER NOT NULL,
      byte_end   INTEGER NOT NULL
    );

dirs:
  add: |
    INSERT INTO dirs (
      path,
      parent_path,
      name,
      timestamp
    )
    VALUES (
      :path,
      :parent_path,
      :name,
      :timestamp
    )

  create: |
    CREATE TABLE IF NOT EXISTS dirs (
      path        TEXT PRIMARY KEY,
      parent_path TEXT,
      name        TEXT NOT NULL,
      timestamp   INTEGER NOT NULL
    );
  
  delete: |
    DELETE FROM dirs
    WHERE path = :path
    LIMIT 1;

  get_all: |
    SELECT *
    FROM dirs
    ORDER BY path;
  
  get_by_parent: |
    SELECT *
    FROM dirs
    WHERE parent_path = :parent_path
    ORDER BY path;
  
  get_by_path: |
    SELECT *
    FROM dirs
    WHERE path = :path;
  
  has_dir?: |
    SELECT COUNT(*) AS count
    FROM dirs
    WHERE path = :path;
  
  update: |
    UPDATE dirs
    SET
      parent_path = :parent_path,
      timestamp   = :timestamp
    WHERE path = :path
    LIMIT 1;

files:
  add: |
    INSERT INTO files (
      path,
      dir_path,
      name,
      hash,
      ctime,
      mtime,
      inode,
      size,
      timestamp
    )
    VALUES (
      :path,
      :dir_path,
      :name,
      :hash,
      :ctime,
      :mtime,
      :inode,
      :size,
      :timestamp
    );

  create: |
    CREATE TABLE IF NOT EXISTS files (
      path      TEXT PRIMARY KEY,
      dir_path  TEXT,
      name      TEXT NOT NULL,
      hash      TEXT,
      ctime     INTEGER DEFAULT 0,
      mtime     INTEGER DEFAULT 0,
      inode     INTEGER DEFAULT 0,
      size      INTEGER DEFAULT 0,
      timestamp INTEGER NOT NULL
    );
  
  delete: |
    DELETE FROM files
    WHERE path = :path
    LIMIT 1;
  
  delete_by_dir_path: |
    DELETE FROM files
    WHERE dir_path = :dir_path;
  
  get_all: |
    SELECT *
    FROM files
    ORDER BY path;
  
  get_by_dir: |
    SELECT *
    FROM files
    WHERE dir_path = :dir_path
    ORDER BY path;
  
  get_by_path: |
    SELECT *
    FROM files
    WHERE path = :path;
  
  has_file?: |
    SELECT COUNT(*) AS count
    FROM files
    WHERE path = :path;

  update: |
    UPDATE files
    SET
      dir_path  = :dir_path,
      hash      = :hash,
      ctime     = :ctime,
      mtime     = :mtime,
      inode     = :inode,
      size      = :size,
      timestamp = :timestamp
    WHERE path = :path
    LIMIT 1;
